<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4" layout:decorator="layout">
<body>
	<div class="top-bar clearfix" layout:fragment="page_header_container">
		<!-- Page-header start -->
		<div class="page-header card">
			<div class="row align-items-end">
				<div class="col-lg-8">
					<div class="page-header-title">
						<i class="fa fa-envira bg-c-blue"></i>
						<div class="d-inline">
							<h4>ファンへの配信広告　案件新規作成</h4>
							<strong class="text-danger">※の項目は、必須項目です。</strong>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Page-header end -->

	<!-- Page body start -->
	<div layout:fragment="page_body_container">
		<form th:action="@{/dsp/completeCampaign}" method="post" th:object="${dspCampaignInputForm}" onsubmit="return check('')">
			<div th:replace="common/errorMessages"></div>
			<div class="card">
				<div class="card-block">
					<h4 class="sub-title">既存テンプレート</h4>
					<div class="form-group row">
						<div class="col-sm-2 text-right">
							<label class="col-form-label">テンプレート名</label>
						</div>
						<div class="col-sm-8">
							<select name="select" class="form-control" th:field="*{templateId}" onchange="refreshVal()" required="required">
								<option th:each="object : ${dspTemplateDtoList}" th:selected="${dspCampaignInputForm.templateId == object.getTemplateId()}" th:value="${object.getTemplateId()}" th:text="${object.getTemplateName()}">--</option>
							</select>
						</div>
					</div>
				</div>
			</div>
			<div class="card">
				<div class="card-block">
					<h4 class="sub-title">基本情報</h4>
					<div class="form-group row">
						<label class="col-sm-2 col-form-label text-right">案件名<span class="text-danger">※</span></label>
						<div class="col-sm-8">
							<input type="text" class="form-control" th:field="*{campaignName}" required="required">
						</div>
					</div>
					<div class="form-group row">
						<label class="col-sm-2 col-form-label text-right">配信開始日<span class="text-danger">※</span></label>
						<div class="col-sm-8">
							<input type="date" class="form-control" th:field="*{startDatetime}" required="required">
						</div>
					</div>
					<div class="form-group row">
						<label class="col-sm-2 col-form-label text-right">配信終了日<span class="text-danger">※</span></label>
						<div class="col-sm-8">
							<input type="date" class="form-control" th:field="*{endDatetime}" required="required">
						</div>
					</div>
					<div class="form-group row">
						<label class="col-sm-2 col-form-label text-right">総予算<span class="text-danger">※</span></label>
						<div class="col-sm-6">
							<input type="number" class="form-control" th:field="*{budget}" required="required" min="1" max="9999999999">
						</div>
						<span class="col-form-label" th:text="'一日最低予算金額 : ¥'+${dailyBudgetFlag}+'円'">円</span>
					</div>
					<div class="form-radio">
						<div class="form-group row">
							<label class="col-sm-2 col-form-label text-right">デバイス<span class="text-danger">※</span></label>
							<div class="radio radio-inline col-sm-2 col-form-label" th:each="deviceType : ${T(jp.acepro.haishinsan.enums.DspDeviceType).values()}">
								<label> <input class="form-control" type="radio" name="radio" th:value="${deviceType.value}" th:field="*{deviceType}" th:text="${deviceType.label}" checked="checked" required="required"> <i class="helper"></i>
								</label>
							</div>
						</div>
					</div>
				</div>
				<div class="card-block">
					<h4 class="sub-title">クリエイティブ情報</h4>
					<div class="form-group row">
						<label class="col-sm-2 col-form-label text-right">クリエイティブ情報<span class="text-danger">※</span></label>
						<div class="col-sm-4" th:if="${#lists.isEmpty(dspCampaignInputForm.dspCampaignCreInputFormList)}">
							<select class="searchable" multiple="multiple" th:field="*{idList}">
								<option th:each="object : ${dspCampaignInputForm.dspCampaignCreInputFormList}" th:value="${object.getCreativeId()}" th:text="${object.getCreativeName()}">日本</option>
							</select>
						</div>
						<div class="col-sm-4" th:unless="${#lists.isEmpty(dspCampaignInputForm.dspCampaignCreInputFormList)}">
							<select class="searchable" multiple="multiple" th:field="*{idList}">
								<option th:each="object : ${dspCampaignInputForm.dspCampaignCreInputFormList}" th:selected="${#lists.contains(dspCampaignInputForm.dspCampaignCreInputFormList, object.getCreativeId())}" th:value="${object.getCreativeId()}" th:text="${object.getCreativeName()}">日本</option>
							</select>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-sm-2 col-form-label text-right">URL<span class="text-danger">※</span></label>
						<div class="col-sm-8">
							<select name="select" class="form-control" th:field="*{url}" required="required">
								<option th:each="dspSegmentDto : ${dspSegmentDtoList}" th:selected="${url==dspSegmentDto.getUrl()}" th:value="${dspSegmentDto.getUrl()}" th:text="${dspSegmentDto.getUrl()}">クリエイティブを選択してください</option>
							</select>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-sm-2 col-form-label"></label>
						<div class="col-sm-12 text-center">
							<button class="btn btn-success" type="submit" sec:authorize="hasAuthority('DSP_CAMPAIGN_MANAGE')" th:formaction="@{/dsp/completeCampaign}" th:formmethod="post">作成</button>
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
	<!-- Page body end -->

	<div layout:fragment="custom_resource_body">
		
		<script>
			$(document).ready(function() {
				$('.lightgallery-popup').lightGallery();
			});
			function refreshVal(sel) {
				var len = $('#len').val();

				for (var i = 0; i < len; i++) {
					var x = "templateId[" + i + "]";
					if (document.getElementById(x).value == sel.value) {
						break;
					}
				}
				if (i < len) {
					var y = "dailyBudget[" + i + "]";
					$("input[id=dailyBudget]").val(
							document.getElementById(y).value);
				} else {
					$("input[id=dailyBudget]").val("");
				}
			}
		</script>
		<script type="text/javascript" src="../files/assets/js/script.js"></script>
		<script type="text/javascript">
			$(function() {
				$('input[name="check"]').change(function() {
					var prop = $('#prop').prop('checked');
					if (prop) {
						$('#p1').show();
					} else {
						$('#p1').hide();
					}
				});
			});
		</script>
		<script th:inline="javascript">
			/*<![CDATA[*/
			
		    var nowTemplateId = $('#templateId').val();
	        function refreshVal(){
	        	var dspTemplateDtoList = /*[[${dspTemplateDtoList}]]*/;
	        	var templateId = $('#templateId').val();
	        	var dspTemplateDto = dspTemplateDtoList.find(
	        		function(element) {
	        		    return element.templateId == templateId;
	        		}
	        	);
	        	
	            if(window.confirm('テンプレート「' + dspTemplateDto.templateName + '」を使用してもよろしいですか？\r\nテンプレートが切り替わると、入力内容は変更されます。')) { 
	            	// 確認時の処理
	            	nowTemplateId = $('#templateId').val();
	            	// multiple select refresh
	            	$("#targetValue").val(dspTemplateDto.targetValue);
	            	$("#accountingMethodFlag").val(dspTemplateDto.accountingMethodFlag);
	            	$("#frequencyCap").val(dspTemplateDto.frequencyCap);
	            	$("#bidCpcPrice").val(dspTemplateDto.bidCpcPrice);
	            	changeAdBlcok();
	            } else { 
	            	// キャンセル時の処理
		            $('#templateId').val(nowTemplateId); // 処理中止
	            }
	        }
	        $(function(){
	        	 var toDay = new Date();
		            var year = toDay.getFullYear();
		            var month = toDay.getMonth()+1 < 10 ? "0"+(toDay.getMonth()+1) : (toDay.getMonth()+1);
		            var day = toDay.getDate() < 10 ? "0"+toDay.getDate() : toDay.getDate();
		            $("#startDatetime").attr("min",year+"-"+month+"-"+day);
		            $("#endDatetime").attr("min",year+"-"+month+"-"+day);
	        });
			/*]]>*/
		</script>
	</div>
</body>
</html>
